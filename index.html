<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>AR Real Estate Business Card ‚Äî MetaMask Noise Hardened</title>

  <!--
    EARLY NOISE SUPPRESSION
    Install global handlers and console wrappers *before* any libraries load so extension errors
    (MetaMask / ethereum / walletconnect) are captured and suppressed from confusing the user.
  -->
  <script>
    (function(){
      // Buffer for suppressed logs so the debug panel can show them later.
      window.__suppressedLogs = window.__suppressedLogs || [];

      // Words to filter (case-insensitive)
      const FILTER = ['metamask','meta-mask','meta mask','ethereum','walletconnect','wallet connect','web3','failed to connect','failed to connect to metamask','connect to metamask'];
      function containsFilter(s){
        if (!s) return false;
        try { s = String(s).toLowerCase(); } catch(e) { return false; }
        return FILTER.some(f => s.includes(f));
      }

      // Save originals
      const _origConsoleError = console.error.bind(console);
      const _origConsoleWarn = console.warn.bind(console);
      const _origConsoleLog = console.log.bind(console);

      // Override console.error / warn to capture and suppress extension noise.
      console.error = function(...args){
        try{
          const joined = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
          if (containsFilter(joined)) {
            window.__suppressedLogs.push({type:'error', msg: joined, time: Date.now()});
            // Still write a subtle debug line to original console.debug so devs can find it if needed
            if (console.debug) console.debug('[suppressed error] (use debug panel)');
            return; // suppress
          }
        }catch(e){}
        _origConsoleError(...args);
      };
      console.warn = function(...args){
        try{
          const joined = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
          if (containsFilter(joined)) { window.__suppressedLogs.push({type:'warn', msg: joined, time: Date.now()}); if (console.debug) console.debug('[suppressed warn]'); return; }
        }catch(e){}
        _origConsoleWarn(...args);
      };

      // Global error / rejection handlers to swallow and log unwanted extension errors
      window.addEventListener('error', function(e){
        try{
          const m = (e && (e.message || e.error && e.error.message)) || e?.toString();
          if (containsFilter(m)) {
            window.__suppressedLogs.push({type:'errorEvent', msg: m, stack: e.error && e.error.stack, time: Date.now()});
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
          }
        }catch(err){}
        // allow other errors to propagate normally
      }, true);

      window.addEventListener('unhandledrejection', function(e){
        try{
          const reason = e?.reason;
          const m = (reason && (reason.message || String(reason))) || String(e);
          if (containsFilter(m)) {
            window.__suppressedLogs.push({type:'unhandledrejection', msg: m, reason: reason, time: Date.now()});
            e.preventDefault();
            return false;
          }
        }catch(err){}
      }, true);

      // Optional: small helper to check if an extension is present
      window.__detectWalletPresence = function(){
        try { return !!(window.ethereum || window.web3); } catch(e){ return false; }
      };
    })();
  </script>

  <!-- Load libraries AFTER we installed error suppression -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root { --ui-bg: rgba(0,0,0,.6); --ui-text: #fff; }
    html,body { height:100%; margin:0; padding:0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial; background:#000 }
    a-scene { position:fixed; inset:0; }

    /* Simple UI */
    .center { position:fixed; inset:0; display:grid; place-items:center; z-index:30; }
    .card { background: rgba(0,0,0,.7); padding:18px; border-radius:12px; text-align:center; color:var(--ui-text); max-width:92vw; }
    .btn { display:inline-flex; gap:.6rem; align-items:center; padding:.6rem .9rem; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:var(--ui-bg); color:var(--ui-text); cursor:pointer; font-weight:600; }

    .bottombar{ position:fixed; left:0; right:0; bottom:12px; display:flex; gap:.6rem; justify-content:center; z-index:25; }
    #debugPanel{ position: fixed; right:12px; top:12px; width:min(92vw,380px); max-height:56vh; overflow:auto; background:var(--ui-bg); color:var(--ui-text); padding:.6rem; border-radius:10px; border:1px solid rgba(255,255,255,.12); z-index:40; display:none; font-size:.85rem; }
    #debugToggle{ position:fixed; right:12px; bottom:12px; z-index:41; }

    /* Hide MindAR's colored scanning UI */
    .mindar-ui-overlay, .mindar-ui-scanning { background: transparent !important; }
    .mindar-ui-scanning .scanning, .mindar-ui-scanning .scanning .inner, .mindar-ui-scanning .scanning .scanline { background: transparent !important; opacity: .0 !important }
    .mindar-ui-loading { background: rgba(0,0,0,.4) !important }
  </style>
</head>
<body>

  <div class="center" id="startGate">
    <div class="card">
      <h2 style="margin:.2rem 0 .6rem;">Start AR Experience</h2>
      <p style="opacity:.95; margin:.2rem 0 .8rem;">Tap Start, allow camera access, and point at your business card.</p>
      <div style="display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap;">
        <button class="btn" id="startBtn">Start</button>
        <button class="btn" id="resetBtn">Reset AR</button>
        <button class="btn" id="debugBtn">Show Debug</button>
      </div>
    </div>
  </div>

  <div class="bottombar">
    <a class="btn" href="https://your-website.example" target="_blank" rel="noopener">üåê Website</a>
    <a class="btn" href="https://instagram.com/yourhandle" target="_blank" rel="noopener">üì∏ Instagram</a>
    <a class="btn" href="mailto:hello@yourdomain.com?subject=Property%20Inquiry">‚úâÔ∏è Email</a>
  </div>

  <div id="debugPanel"></div>

  <!-- AR scene: keep uiScanning off to avoid the blue scanning overlay -->
  <a-scene id="scene"
           mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: false; uiLoading: true;"
           embedded
           color-space="sRGB"
           renderer="precision: mediump; antialias: true; alpha: false; colorManagement: true; physicallyCorrectLights: true"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true">

    <a-assets timeout="25000">
      <a-asset-item id="avatarGLB" src="./assets/avatar.glb" crossorigin="anonymous"></a-asset-item>
      <video id="propVideo" src="./assets/properties.mp4" preload="auto" loop playsinline webkit-playsinline muted crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <a-entity id="avatar" gltf-model="#avatarGLB" position="0 0 0" scale="0.28 0.28 0.28" rotation="0 180 0" animation-mixer></a-entity>
      <a-video id="videoPlane" src="#propVideo" width="0.98" height="0.55" position="0 0.5 0" rotation="-10 0 0" material="shader: flat"></a-video>
    </a-entity>

  </a-scene>

  <script>
    // Small helpers
    const $ = (s)=>document.querySelector(s);
    const logToDebug = (msg, data)=>{
      const panel = $('#debugPanel');
      if (!panel) return;
      panel.style.display = 'block';
      const pre = document.createElement('pre');
      pre.textContent = `[${new Date().toLocaleTimeString()}] ${msg}${data? ' ‚Äî ' + (typeof data === 'string' ? data : JSON.stringify(data,null,2)):''}`;
      panel.appendChild(pre);
      panel.scrollTop = panel.scrollHeight;
    };

    // Expose suppressed logs captured by early script
    function flushSuppressedLogs(){
      try{
        if (Array.isArray(window.__suppressedLogs) && window.__suppressedLogs.length){
          window.__suppressedLogs.forEach(s => logToDebug('[suppressed]', s));
          window.__suppressedLogs.length = 0;
        }
      }catch(e){ console.warn('flushSuppressedLogs failed', e); }
    }

    // Preflight tests (kept as requested)
    async function testHTTPS(){ const ok = location.protocol === 'https:' || location.hostname === 'localhost'; logToDebug('Test: HTTPS or localhost', {result: ok, protocol: location.protocol}); return ok; }
    async function testWebGL(){ let gl=null; try{ const c=document.createElement('canvas'); gl = c.getContext('webgl') || c.getContext('experimental-webgl'); }catch{} const ok=!!gl; logToDebug('Test: WebGL', {result: ok}); if(!ok) alert('WebGL unavailable'); return ok; }
    async function testPermissions(){ if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ logToDebug('Test: getUserMedia', 'API missing'); alert('Camera API missing'); return false; } try{ const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}}); s.getTracks().forEach(t=>t.stop()); logToDebug('Test: getUserMedia', 'ok'); return true; }catch(e){ logToDebug('Test: getUserMedia', {name:e.name, message:e.message}); alert('Please allow camera access'); return false; } }
    async function testAssets(){ async function headOK(url){ try{ const r = await fetch(url, {method:'HEAD'}); return r.ok; }catch{ return false; }} const res = {targets: await headOK('./targets.mind'), avatar: await headOK('./assets/avatar.glb'), video: await headOK('./assets/properties.mp4')}; logToDebug('Test: assets', res); if(!res.targets) alert('Missing targets.mind at ./targets.mind'); return res; }
    async function testAutoplay(){ const v = $('#propVideo'); try{ await v.play(); logToDebug('Test: autoplay (muted)', 'ok'); v.pause(); }catch(e){ logToDebug('Test: autoplay (muted)', {err: e.message||e}); } return true; }
    function testExtension(){ const present = !!(window.ethereum || window.web3 || window.__detectWalletPresence && window.__detectWalletPresence()); logToDebug('Test: wallet extension present', {present}); return present; }
    function testConsoleFilter(){ // ensure early suppression captured a simulated error
      // Push a synthetic message into console and see if it ends up suppressed (our early override records it)
      try{
        console.error('s: Failed to connect to MetaMask (simulated test)');
        const suppressed = Array.isArray(window.__suppressedLogs) && window.__suppressedLogs.some(x=>String(x.msg||'').toLowerCase().includes('metamask'));
        logToDebug('Test: console filter', {suppressed});
        return suppressed;
      }catch(e){ logToDebug('Test: console filter error', e.message||e); return false; }
    }

    // Lifecycle
    const scene = $('#scene');
    const anchor = $('#anchor');
    const startGate = $('#startGate');
    const startBtn = $('#startBtn');
    const resetBtn = $('#resetBtn');
    const debugBtn = $('#debugBtn');

    // Scene events
    scene.addEventListener('loaded', ()=> logToDebug('A-Frame scene loaded'));
    scene.addEventListener('arReady', ()=> logToDebug('MindAR arReady'));
    scene.addEventListener('arError', (e)=> logToDebug('MindAR arError', e && e.detail ? e.detail : e));
    anchor.addEventListener('targetFound', ()=> logToDebug('Target Found'));
    anchor.addEventListener('targetLost', ()=> logToDebug('Target Lost'));

    async function startMindAR(){
      // Ensure systems are ready
      if (!scene.systems || !scene.systems['mindar-image-system']){
        await new Promise(r=> scene.addEventListener('loaded', r, {once:true}));
      }
      try{
        await scene.systems['mindar-image-system'].start();
        logToDebug('MindAR started');
      }catch(e){ logToDebug('startMindAR failed', {name:e.name, msg:e.message}); alert('Failed to start AR ‚Äî check camera permissions and targets.mind'); }
    }
    async function stopMindAR(){ try{ if (scene.systems && scene.systems['mindar-image-system']){ await scene.systems['mindar-image-system'].stop(); logToDebug('MindAR stopped'); } }catch(e){ logToDebug('stopMindAR failed', e.message||e); } }

    async function boot(){
      // show any suppressed extension logs first
      flushSuppressedLogs();

      const ok1 = await testHTTPS(); if(!ok1){ alert('Serve the page via HTTPS or use localhost'); return; }
      const ok2 = await testWebGL(); if(!ok2) return;
      const ok3 = await testPermissions(); if(!ok3) return;
      const assets = await testAssets();
      testExtension();
      await testAutoplay();
      testConsoleFilter();

      await startMindAR();
      // prime video (muted)
      const v = $('#propVideo'); try{ await v.play(); }catch{}
    }

    startBtn.addEventListener('click', async ()=>{ startGate.style.display='none'; await boot(); });
    resetBtn.addEventListener('click', async ()=>{ await stopMindAR(); startGate.style.display='grid'; logToDebug('Reset: AR stopped'); });
    debugBtn.addEventListener('click', ()=>{ const panel = $('#debugPanel'); panel.style.display = panel.style.display==='block' ? 'none' : 'block'; debugBtn.textContent = panel.style.display==='block' ? 'Hide Debug' : 'Show Debug'; flushSuppressedLogs(); });

    // convenience: allow tap anywhere to auto-start on mobile
    window.addEventListener('touchend', function autoStartOnce(){ if (startGate.style.display !== 'none'){ startBtn.click(); } window.removeEventListener('touchend', autoStartOnce); }, { passive:true });

    // Final note: if you still see "Failed to connect to MetaMask" in the browser UI, it is coming from a browser extension.
    // Disable the extension (or run in an Incognito window with extensions disabled) to fully eliminate the message.
  </script>

  <!--
    HOW TO USE
    1) Required files (place in same folder):
       - ./targets.mind        (compiled from your business card image using MindAR target compiler)
       - ./assets/avatar.glb  (3D avatar)
       - ./assets/properties.mp4 (promo video)
    2) Host on HTTPS or run on localhost.
    3) Click Start and allow camera.

    TESTS RUN DURING BOOT (kept + added):
      - HTTPS or localhost
      - WebGL available
      - getUserMedia (camera permission)
      - assets existence (targets.mind, avatar.glb, properties.mp4)
      - video autoplay (muted)
      - wallet extension presence (informational)
      - console filter test (simulates a MetaMask message and verifies suppression)
  -->
</body>
</html>
